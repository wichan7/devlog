---
title: Puppeteerã‚¦ã‚§ãƒ–ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆ - 2
description: ç›´æ¥å®Ÿè£…ã—ã¦ã¿ã‚‹
date: 2023-09-17
tags:
  - Web
  - Crawling
---
## æ¦‚è¦
[ğŸ‘‰ ã‚¦ã‚§ãƒ–ã‚¯ãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆ - 1 ã™ãã«ç§»å‹•](https://wichan7.github.io/web/web-crawling-1/)  

Puppeteerã€Cheerioãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’æ´»ç”¨ã—ã¦ã€ã‚¦ã‚§ãƒ–ãƒšãƒ¼ã‚¸ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åé›†ã™ã‚‹ã‚¯ãƒ­ãƒ¼ãƒªãƒ³ã‚°ãƒœãƒƒãƒˆã‚’æ§‹æˆã—ãŸã€‚  
`Trigger Page`ã‹ã‚‰ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’åé›†ã—ã€`<a href=...>`ã‚’æ¢ç´¢ã—ã¦é‡è¤‡ãªãè¨ªå•ã™ã‚‹ã€‚  

## ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
[ğŸ‘‰ Puppeteer Documentation](https://pptr.dev/)  
[ğŸ‘‰ Cheerio](https://cheerio.js.org/docs/intro)  

## ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
``` javascript showLineNumbers
// crawl.js
// 3rd party declaration
import * as puppeteer from 'puppeteer';
import * as cheerio from 'cheerio';
// own libraries declaration
import Queue from './queue.js';

/**
 * Concept:
 *  1. visitQueueã‹ã‚‰url dequeue
 *  2. urlè¨ªå•
 *  3. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒªã‚¹ãƒˆæŠ½å‡º
 *  4. hrefæŠ½å‡ºã€visitQueueã«enqueue
 *  6. 1 ~ 4 ç¹°ã‚Šè¿”ã—
 */
(async() => {
    const emails = new Set();
    const histories = new Set();
    const visitQueue = new Queue();

    const browser = await puppeteer.launch();
    const workPage = await browser.newPage();

    // Trigger Pageè¨­å®š
    visitQueue.enqueue("https://www.naver.com");
    while (!visitQueue.isEmpty()) {
        // 1.
        const url = visitQueue.dequeue();
        // 2.
        await workPage.goto(url);
        // 3.
        const $ = cheerio.load(await workPage.content());
        for (let email of extractEmails($)) {
            emails.add(email);
        }
        // 4.
        for (let href of validateHrefs(extractHrefs($), histories)) {
            visitQueue.enqueue(href);
        }
        // logging
        console.log(emails);
    }
})();

function extractEmails($) {
    /**
     * RFC2822 Email Validation
     */
    return $('body').text().match(/[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/g) || [];
}

function extractHrefs($) {
    const hrefs = [];

    $('a').each( (i, a) => {
        const href = $(a).attr('href') || "";
        if (href.startsWith("https://") || href.startsWith("http://")) {
            hrefs.push(href);
        }
    } );

    return hrefs;
}

function validateHrefs(hrefs, histories) {
    return hrefs.filter( href => !histories.has(href) )
}

async function wait(seconds) {
    return new Promise( resolve => setTimeout(resolve, seconds * 1000) )
}
```

``` javascript showLineNumbers
// queue.js
export default class Queue {
    constructor() {
        this.arr = []
    }

    enqueue(element) {
        this.arr.push(element)
    }

    dequeue() {
        return this.arr.shift()
    }

    isEmpty() {
        return this.arr.length === 0 ? true : false
    }
}
```

## æ”¹å–„æ–¹å‘
1. Queryã€Path Parameterã«å¯¾ã™ã‚‹trimå¾Œã€é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œã—ãªã‘ã‚Œã°ã€æ„å‘³ã®ãªã„ãƒšãƒ¼ã‚¸ã«é‡è¤‡è¨ªå•ã—ãªã„ã€‚ï¼ˆCanonical Tagã‚’æ´»ç”¨ã™ã‚Œã°ã‚ˆã„ã‹ã‚‚ï¼Ÿï¼‰  
2. hrefã«Full URLã§ã¯ãªãã€`'/path'`ã€`'./path'`ãªã©ãƒ‘ã‚¹ãŒå…¥ã£ã¦ãã‚‹å ´åˆã¯ç ´æ£„ã—ã¦ã„ã‚‹ãŒã€baseUrlã‚’å–å¾—ã§ãã‚Œã°ã€pathã¨base_urlã®åˆæˆãŒå¯èƒ½ã§ã‚ã‚‹ã€‚
